# GunBoat training config from scratch (stage 2)
#
# Used to run the main training DORA-7p.

includes { path: "rollouters/cfr1p_20210501_rl_rollouts.prototxt"; mount: "search_rollout.agent" }
includes { path: "opponents/cfr1p_20210501_translite_rol0"; mount: "search_rollout.h2h_eval_0" }
includes { path: "opponents/dipnet_20210501_heavyish"; mount: "search_rollout.h2h_eval_1" }
exploit {
    model_path: "PATH_TO_STAGE1/ckpt/epoch000600.ckpt"
    value_model_path: "PATH_TO_STAGE1/ckpt_value/epoch000600.ckpt"

    critic_weight: 1.0
    discounting: 1.0
    search_policy_weight: 0.1
    search_policy_max_prob_cap: 0.45
    num_train_gpus: 4
    bootstrap_offline_targets: true
    use_distributed_data_parallel: true
    optimizer {
        adam {
            lr: 1e-4
        }
        warmup_epochs: 100
        grad_clip: 0.5
    }
    search_rollout {
        extra_params {
            explore_eps: 0.1
            explore_s1901m_eps: 0.3
            explore_f1901m_eps: 0.2
            independent_explore: true
            use_trained_policy: 1
            do {
                max_iters: 14
                min_diff: 0.04
                generation {
                    max_actions: 1000
                    local_uniform {
                        num_base_actions: 10
                        use_search_policy: true
                        fix_uncoordinated_base: true
                        with_holes: true
                    }
                }
                max_op_actions: 10
                shuffle_powers: true
                use_exact_op_policy: false
            }
            run_do_prob: 0.1
            use_ev_targets: true
            use_cfr_evs: true
            allow_policy_tragets_without_do: true
        }
        chunk_length: 128
        batch_size: 8
        warmup_batches: 500
        num_workers_per_gpu: 8
        num_cores_to_reserve: 70
        draw_on_stalemate_years: 3
        enforce_train_gen_ratio: 6
        buffer {
            shuffle: 1
            prefetch: 5
            capacity: 10000
        }
        test_situation_eval {
            do_eval: false
        }
    }
    trainer {
        max_epochs: 9001
        epoch_size: 100
        save_checkpoint_every: 100
        save_sync_checkpoint_every: 40
    }
    launcher {
        slurm {
            num_gpus: 240
        }
    }
}
